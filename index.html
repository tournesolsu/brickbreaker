<html>
	<head>
		<title>brick breaker</title>
		<script>
			//代码就写在这里
			var context;
			// now let's load the image and draw it on the canvas
			// set up a  var of the paddle
			var paddle = new Image();
			// set it's content(the image file name)
			paddle.src = "paddle.png";

			var ball = new Image();
			ball.src = "ball.png";
			
			var brick = new Image();
			brick.src = "brick.png";

			var score = 100;
			var scorePerHit = 10;
			var paddleX = 190;
			var paddleY = 300;
			var ballX = paddleX + 45;
			var ballY = paddleY - 10;
			var brickX = 250;
			var brickY = 150;

			var speed = 10;
			var ballSpeedX = 5;
			var ballSpeedY = 5;
			// define two vars, left key and right key
			// watch and learn !!-_-
			var keyCode;
			var kKeyCodeEnter = 13;
			var kKeyCodeLeft = 37;
			var kKeyCodeUp = 38;
			var kKeyCodeRight = 39;
			var keyIsDown = false;
			var ballIsFlying = false;
			var gameIsOver = false;
			var brickIsDead = false;

			// set up update and draw
			// see how do we define a function in javascript
			// it's diff from scheme

			var resetGame = function(){
				ballIsFlying = false;
				gameIsOver = false;
				brickIsDead = false;
				paddleX = 190;
				paddleY = 300;
				ballX = paddleX + 45;
				ballY = paddleY - 10;
				score = 100;
			};
			var update = function() {
				// let's update the position of paddle here
				if(ballY > 320) {
					gameIsOver = true;
				}
				if(keyIsDown) {
					// do you remember if statement?
					if(keyCode == kKeyCodeLeft) {
						if(paddleX - speed >= 0) {
							paddleX = paddleX - speed;
							if(!ballIsFlying) {
								// you, do it
								//gpcu!!!!!
								// right key.
								ballX = paddleX + 45;
							}
						}
						//left key
						
					} else if (keyCode == kKeyCodeRight) {
						// right key
						if(paddleX + speed <= 480 - paddle.width){
							paddleX = paddleX + speed;
							if(!ballIsFlying) {
								ballX = paddleX + 45;
							}
						}
					} else if(keyCode == kKeyCodeUp) {
						// fire the BALL!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
						// sorry, so excited
						// I'm gonna fire it!!!
						ballIsFlying = true;
					} else if(gameIsOver && keyCode == kKeyCodeEnter) {
						// reset game
						resetGame();
					}
					//if()
				}
				if(ballIsFlying) {
					if(ballX + ballSpeedX > 480 - ball.width) {
						ballSpeedX = -ballSpeedX;
					} else if(ballX + ballSpeedX < 0) {
						ballSpeedX = -ballSpeedX;
					}
					if(ballY - ballSpeedY < 0) {
						ballSpeedY = -ballSpeedY;
					}
					if(ballY + ball.height == paddleY) {
						if(ballX + ball.width > paddleX && ballX < paddleX + paddle.width) {
							if(ballSpeedY < 0) {
								ballSpeedY = -ballSpeedY;
								score = score + scorePerHit;
								console.log(score);
							}
						}
					}
					ballX = ballX + ballSpeedX;			
					ballY = ballY - ballSpeedY;
				}
				if(! brickIsDead) {
					if((ballX + ball.width == brickX && ballY < brickY + brick.height && ballY + ball.height > brickY) ||
					(ballX == brickX + brick.width && ballY < brickY + brick.height && ballY + ball.height > brickY)) {
						brickIsDead = true;
						ballSpeedX = -ballSpeedX;
					} else if((ballY + ball.height == brickY && ballX + ball.width > brickX && ballX < brickX + brick.width) ||
					(ballY == brickY + brick.height && ballX + ball.width > brickX && ballX < brickX + brick.width ) ) {
						brickIsDead = true;
						ballSpeedY = -ballSpeedY;
					}	
				}
				
			};
			var drawScore = function(s) {
				context.fillStyle = '#fff';   
				context.font = 'italic 30px Courier New';   
				context.fillText('Score: ' + s, 0, 30);
			};
			var gameOver = function(g) {
				context.fillStyle = '#FF0000';
				context.font = 'bold 50px sans-serif';
				context.fillText('Game Over', 130, 130);
			};
			var draw = function() {
				// first we clear the entire canvas, remember ?
				context.clearRect(0, 0, 480, 320);
				// draw paddle
				context.drawImage(paddle,
				 0, 0, paddle.width, paddle.height,
				 paddleX, 300, paddle.width, paddle.height);
				context.drawImage(ball, 0, 0, ball.width, ball.height, 
					ballX, ballY, ball.width, ball.height);
				drawScore(score);
				if(gameIsOver) {
					gameOver();
				}
				if(! brickIsDead) {
				context.drawImage(brick, 0, 0, brick.width, brick.height,
					brickX, brickY, brick.width, brick.height);
				}
			};
			//var key_is_down = false;
			// which one do you prefer? aha.

			// key event listener
			document.onkeydown = function(event) {
				//
				console.log('key is down');
				keyIsDown = true;
				keyCode = event.keyCode;
			};
			document.onkeyup = function(event) {
				console.log('key is up');
				keyIsDown = false;
			};
			// this will be called after all elements loaded

			var onTouchStart = function(event) {
				// 
				event.preventDefault();
				//
				keyIsDown = true;
				// multi-touch, get the first point
				var x = event.touches[0].clientX;
				var y = event.touches[0].clientY;
				if(y < 200) {
					// fire the ball
					keyCode = kKeyCodeUp;
					if(gameIsOver) {
						keyCode = kKeyCodeEnter;
					}
				} else {
					if(x < 240) {
						keyCode = kKeyCodeLeft;
					} else {
						keyCode = kKeyCodeRight;
					}
				}
			};
			var onTouchEnd = function(event) {
				event.preventDefault();
				keyIsDown = false;
			}
			window.onload = function() {
				context = document.getElementById('canvas').getContext('2d');
				//set up FPS of our game
				var fps = 60;
				//var fps=20; this is a bad practice, don't do like this
				//add touch event listener here
				// wait me a while...
				canvas.addEventListener('touchstart', onTouchStart, false);
				canvas.addEventListener('touchend', onTouchEnd, false);
				setInterval(update, 1000 / fps);
				setInterval(draw, 1000 / fps);
			}
		</script>
	</head>
	<body>
		<canvas id="canvas" width="480" height="320" style="background:black">
	</body>
</html>